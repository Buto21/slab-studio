<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Slab Studio Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        :root { --purple: #d844ff; --blue: #00f2ff; --bg: #050505; --panel: #111; --red: #ff3333; --green: #33ff33; --orange: #ff9d00; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; transition: background 0.2s; overflow-x: hidden; }
        .warp-flash { background: #2a1a00 !important; }
        .rack { width: 100%; max-width: 850px; background: var(--panel); border: 2px solid #333; border-radius: 12px; padding: 20px; position: relative; box-shadow: 0 0 100px #000; transition: border-color 0.2s; }
        .emergency-border { border-color: var(--orange) !important; }
        .screen { background: #000; border: 1px solid #333; border-radius: 6px; padding: 15px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; position: relative; overflow: hidden; }
        @media (min-width: 600px) { .screen { flex-direction: row; padding: 20px; } }
        .art-frame { width: 100%; aspect-ratio: 1/1; max-width: 180px; margin: 0 auto; background: #0a0a0a; border: 1px solid #222; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; z-index: 2; }
        #cover-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .rec-light { position: absolute; top: 10px; right: 10px; width: 10px; height: 10px; background: #200; border-radius: 50%; }
        .rec-active { background: var(--red); box-shadow: 0 0 10px var(--red); animation: blink 1s infinite; }
        .info-col { flex-grow: 1; min-width: 0; z-index: 2; }
        .meta h2 { font-size: 1.2rem; margin: 5px 0; color: #fff; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-wrap { height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .bar-fill { height: 100%; width: 0%; background: var(--blue); transition: width 0.1s linear; }
        .terminal { height: 80px; background: #030303; border: 1px solid #222; border-radius: 4px; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.7rem; overflow-y: auto; color: #555; margin-top: 10px; }
        .t-success { color: var(--blue); } .t-emergency { color: var(--orange); font-weight: bold; } .t-fx { color: var(--purple); font-style: italic; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        @media (min-width: 600px) { .btn-grid { grid-template-columns: 2fr 1fr 1fr 1fr; } }
        button { padding: 16px; background: #1a1a1a; color: #888; border: 1px solid #333; font-weight: 900; cursor: pointer; font-size: 0.7rem; border-radius: 4px; }
        #btn-engage { background: var(--purple); color: #000; border: none; grid-column: span 2; }
        @media (min-width: 600px) { #btn-engage { grid-column: span 1; } }
        #btn-dl.ready { color: var(--blue) !important; border-color: var(--blue) !important; }
        .mini-btn { padding: 15px; border: 1px dashed #444; color: #bbb; font-size: 0.8rem; font-weight: 900; cursor: pointer; display: block; text-align: center; margin-top: 15px; background: #0a0a0a; border-radius: 4px; }
        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div class="rack" id="main-rack">
    <div class="screen" id="main-screen">
        <div class="art-frame"><div class="rec-light" id="rec-dot"></div><img id="cover-img"></div>
        <div class="info-col">
            <div class="meta">
                <h4 id="meta-album" style="color:var(--purple); font-size: 0.6rem; margin:0;"></h4>
                <h2 id="meta-title">STATION IDLE</h2>
                <h5 id="meta-artist" style="color:#888; font-size: 0.7rem; margin:0;"></h5>
            </div>
            <div style="margin-top:15px;">
                <div class="bar-wrap"><div class="bar-fill" id="source-fill"></div></div>
                <div class="bar-wrap"><div class="bar-fill" id="session-fill" style="background: var(--purple);"></div></div>
            </div>
            <div class="terminal" id="term">V26.2 BACKGROUND ENGINE READY.</div>
        </div>
    </div>
    <div style="display: flex; gap: 10px; background: #151515; padding: 12px; border-radius: 4px; font-size: 0.8rem; align-items: center;">
        <input type="checkbox" id="chk-endless"> <label for="chk-endless">INFINITE MODE</label>
    </div>
    <div class="btn-grid">
        <button id="btn-engage" disabled>ENGAGE SYSTEM</button>
        <button id="btn-stop" onclick="location.reload()">STOP</button>
        <button id="btn-dl" disabled>SAVE</button>
    </div>
    <label class="mini-btn">LOAD TRACK FROM PHONE<input type="file" id="file-in" accept="audio/*" hidden></label>
</div>

<script>
    const SCREW_RATE = 0.75, SESSION_LIMIT = 480, WARP_INT = 30;
    let audioCtx, buffer, source, gainNode, masterBus, recorder, chunks = [], heartbeat, wakeLock = null;
    let state = { playing: false, start: 0, offset: 0, sessionStart: 0, nextChaos: 0, nextWarpCheck: 0, isOutro: false, warpCount: 0, lastRewind: 0 };
    let metadata = { title: "STATION RECORDING", artist: "UNKNOWN" };

    const ui = {
        term: document.getElementById('term'), title: document.getElementById('meta-title'),
        artist: document.getElementById('meta-artist'), art: document.getElementById('cover-img'),
        engage: document.getElementById('btn-engage'), dl: document.getElementById('btn-dl'),
        rec: document.getElementById('rec-dot'), rack: document.getElementById('main-rack'),
        endless: document.getElementById('chk-endless'), sFill: document.getElementById('source-fill'), 
        sessFill: document.getElementById('session-fill')
    };

    function log(msg, cls) {
        const div = document.createElement('div'); if(cls) div.className = cls;
        div.innerHTML = `> ${msg}`; ui.term.appendChild(div); ui.term.scrollTop = ui.term.scrollHeight;
    }

    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }

    function updateMediaSession() {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: metadata.title, artist: metadata.artist, album: 'Slab Studio Mobile'
            });
        }
    }

    document.getElementById('file-in').onchange = async (e) => {
        const file = e.target.files[0]; if(!file) return;
        jsmediatags.read(file, { onSuccess: (t) => {
            metadata.title = (t.tags.title || file.name).toUpperCase();
            metadata.artist = (t.tags.artist || "UNKNOWN").toUpperCase();
            ui.title.textContent = metadata.title; ui.artist.textContent = metadata.artist;
            if(t.tags.picture) {
                const b = new Blob([new Uint8Array(t.tags.picture.data)], {type: t.tags.picture.format});
                ui.art.src = URL.createObjectURL(b); ui.art.style.display = "block";
            }
        }});
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        buffer = await audioCtx.decodeAudioData(await file.arrayBuffer());
        ui.engage.disabled = false; log("SIGNAL CAPTURED.");
    };

    function play(pos, isWarp = false, isEmergency = false) {
        const now = audioCtx.currentTime;
        const g = audioCtx.createGain();
        g.gain.setValueAtTime(0, now);
        g.gain.setTargetAtTime(0.8, now, 0.04);
        const filter = audioCtx.createBiquadFilter();
        filter.type = isWarp ? "lowpass" : "allpass";
        if(isWarp) {
            filter.frequency.setValueAtTime(150, now);
            filter.frequency.exponentialRampToValueAtTime(18000, now + 0.6);
            state.warpCount++;
            if(isEmergency) { log(`EMERGENCY WARP.`, "t-emergency"); document.body.classList.add('warp-flash'); setTimeout(()=>document.body.classList.remove('warp-flash'), 400); }
            else { log(`Warp successful.`, "t-success"); }
        }
        filter.connect(g); g.connect(masterBus);
        const s = audioCtx.createBufferSource();
        s.buffer = buffer; s.playbackRate.value = isWarp ? 0.2 : SCREW_RATE;
        if(isWarp) s.playbackRate.exponentialRampToValueAtTime(SCREW_RATE, now + 0.6);
        s.connect(filter);
        if(source) { gainNode.gain.setTargetAtTime(0, now, 0.03); source.stop(now + 0.2); }
        s.start(now, Math.max(0, pos));
        source = s; gainNode = g; state.start = now; state.offset = pos;
    }

    function tick() {
        if(!state.playing) return;
        const now = audioCtx.currentTime;
        const elapsed = now - state.sessionStart;
        const curPos = state.offset + ((now - state.start) * SCREW_RATE);
        ui.sFill.style.width = `${(curPos / buffer.duration) * 100}%`;
        ui.sessFill.style.width = `${Math.min(100, (elapsed / SESSION_LIMIT) * 100)}%`;

        if(!ui.endless.checked && elapsed >= 450 && !state.isOutro) {
            state.isOutro = true; log("OUTRO INITIATED.");
            masterBus.gain.linearRampToValueAtTime(0, now + 30);
        }
        if(!ui.endless.checked && elapsed >= SESSION_LIMIT) { stopSession(); return; }
        if(curPos >= (buffer.duration - 15)) { play(Math.random() * (buffer.duration - 20), true, true); return; }

        if(now >= state.nextWarpCheck) {
            state.nextWarpCheck = now + WARP_INT;
            if(Math.random() < 0.5) play(Math.random() * (buffer.duration - 20), true, false);
        }
        if(now >= state.nextChaos) {
            const r = Math.random();
            if (r < 0.15 && (now - state.lastRewind > 10)) {
                log("FX: REWIND", "t-fx"); play(curPos - 2.0); state.lastRewind = now; state.nextChaos = now + 3.5;
            } else if (r < 0.75) {
                const v = Math.random();
                if(v < 0.6) { log("FX: CHOP"); play(curPos - 0.38); }
                else { log("FX: SKIP"); play(curPos + 0.4); }
                state.nextChaos = now + 2.2;
            } else { state.nextChaos = now + 5; }
        }
    }

    function stopSession() {
        clearInterval(heartbeat); state.playing = false; if(source) source.stop();
        ui.rec.classList.remove('rec-active'); if(recorder && recorder.state !== 'inactive') recorder.stop();
        if(wakeLock) wakeLock.release(); log("SESSION SAVED.");
    }

    ui.engage.onclick = async () => {
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        await requestWakeLock(); updateMediaSession();
        masterBus = audioCtx.createGain(); masterBus.connect(audioCtx.destination);
        const dest = audioCtx.createMediaStreamDestination(); masterBus.connect(dest);
        recorder = new MediaRecorder(dest.stream, { mimeType: 'audio/webm;codecs=opus' });
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            ui.dl.disabled = false; ui.dl.classList.add('ready');
            ui.dl.onclick = () => {
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `${metadata.artist} - ${metadata.title}.webm`; a.click();
            };
        };
        recorder.start(); state.playing = true; state.sessionStart = audioCtx.currentTime;
        state.nextChaos = audioCtx.currentTime + 3; state.nextWarpCheck = audioCtx.currentTime + 15;
        ui.rec.classList.add('rec-active'); log("SYSTEM ONLINE.");
        play(0); heartbeat = setInterval(tick, 100); ui.engage.disabled = true;
    };
</script>
</body>
</html>
